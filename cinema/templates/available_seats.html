<!doctype html>

<html lang="fa">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>انتخاب صندلی</title>

  <style>
    :root{
      --bg:#0f1724;
      --card:#0b1220;
      --muted:#9aa6b2;
      --accent:#0ea5a4;
      --seat-free:#1f2937;
      --seat-selected:#06b6d4;
      --seat-taken:#374151;
      --seat-pending:#ffd700;
      --shadow: 0 6px 18px rgba(2,6,23,0.6);
      --max-width: 1100px;
    }
    html,body{
      height:100%;
      background: linear-gradient(180deg,#071226 0%,#051222 100%);
      color: #e6eef1;
      font-family: "Vazirmatn", "Tahoma", sans-serif;
      margin:0; padding:24px;
      direction: rtl;
    }

    .container{
      max-width: var(--max-width);
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 320px;
      gap:20px;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius: 12px;
      padding: 18px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,0.03);
    }

    header h1{ margin:0 0 6px 0; font-size:18px; }
    header p{ margin:0; color:var(--muted); font-size:13px; }

    .screen {
      height: 36px;
      background: linear-gradient(90deg,#e6eef1 0%, rgba(230,238,241,0.05) 100%);
      border-radius: 8px;
      margin: 8px auto 18px auto;
      width: 80%;
      color:#071226;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:600;
    }

    .seats-wrap{
      display:flex;
      justify-content:center;
      align-items:flex-start;
      overflow:auto;
      padding:8px;
    }

    .seat-grid{
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .seat-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .row-label {
      width: 30px;
      text-align: center;
      font-weight: bold;
      color: var(--muted);
    }

    .row-seats {
      display: flex;
      gap: 8px;
    }

    .seat{
      width:44px; height:36px;
      border-radius:6px;
      background:var(--seat-free);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      font-size:12px;
      color:var(--muted);
      user-select:none;
      transition: transform .12s ease;
    }
    .seat:hover{ transform: translateY(-4px); }
    .seat.taken{
      background:var(--seat-taken);
      cursor:not-allowed;
      color:#999;
    }
    .seat.pending{
      background:var(--seat-pending);
      cursor:not-allowed;
      color:#000;
    }
    .seat.selected{
      background:var(--seat-selected);
      color:#082226;
      font-weight:700;
    }

    .sidebar h3{ margin-top:0; }
    .legend{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:12px;
    }
    .legend .item{
      display:flex;
      gap:8px;
      align-items:center;
      font-size:13px;
      color:var(--muted);
    }
    .legend .swatch{
      width:26px; height:18px; border-radius:4px;
    }

    .summary{ margin-top:12px; font-size:14px; color:var(--muted); }
    .price{ font-size:20px; font-weight:700; margin-top:8px; color:var(--accent); }

    button.primary{
      width:100%;
      margin-top:14px;
      padding:10px 14px;
      border-radius:10px;
      border:0;
      background: linear-gradient(90deg,var(--accent),#06b6d4);
      color:#071226;
      font-weight:700;
      cursor:pointer;
    }
    button.primary:disabled{ opacity:0.5; cursor:not-allowed; }
  </style>

</head>
<body>

  <div class="container">
    <main class="card">
      <header>
        <h1>انتخاب صندلی — سالن {{ show_time.hall }}</h1>
        <p>فیلم: {{ show_time.movie }}</p>
        <p>سانس: {{ show_time.start_time }}</p>
      </header>


  <div class="screen">پرده</div>

  <div class="seats-wrap">
    <div id="seatGrid" class="seat-grid">
      {% regroup seats by row as row_list %}
      {% for row in row_list %}
        <div class="seat-row">
          <div class="row-label">{{ row.grouper }}</div>
          <div class="row-seats">
            {% for seat in row.list %}
              <div class="seat" id="seat-{{ seat.id }}" data-seat="{{ seat.id }}">
                {{ seat.number }}
              </div>
            {% endfor %}
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
</main>

<aside class="card sidebar">
  <h3>جزئیات رزرو</h3>

  <div class="legend">
    <div class="item"><div class="swatch" style="background:var(--seat-free)"></div> آزاد</div>
    <div class="item"><div class="swatch" style="background:var(--seat-selected)"></div> انتخاب‌شده</div>
    <div class="item"><div class="swatch" style="background:var(--seat-taken)"></div> رزروشده</div>
    <div class="item"><div class="swatch" style="background:var(--seat-pending)"></div> در انتظار</div>
  </div>

  <div class="summary">
    <div>صندلی‌های انتخاب‌شده:</div>
    <div id="chosenList" style="margin-top:6px; color:#e6eef1; font-weight:600;"></div>
    <div class="price" id="totalPrice">مجموع: 0 تومان</div>
    <button id="reserveBtn" class="primary" disabled>تایید رزرو</button>
  </div>
</aside>


  </div>

  <script>
    const SEAT_PRICE = 45000;
    const selected = new Set();

    document.querySelectorAll('.seat').forEach(seat => {
      seat.addEventListener('click', () => {
        if (seat.classList.contains('taken') || seat.classList.contains('pending')) return;
        const seatId = seat.dataset.seat;
        if (seat.classList.contains('selected')) {
          seat.classList.remove('selected');
          selected.delete(seatId);
        } else {
          seat.classList.add('selected');
          selected.add(seatId);
        }
        refreshSummary();
      });
    });

    function refreshSummary() {
      const chosenList = document.getElementById('chosenList');
      const totalPriceEl = document.getElementById('totalPrice');
      const reserveBtn = document.getElementById('reserveBtn');
      const arr = Array.from(selected);
      chosenList.textContent = arr.length ? arr.join(' ، ') : 'هیچ صندلی انتخاب نشده';
      totalPriceEl.textContent = 'مجموع: ' + (arr.length*SEAT_PRICE).toLocaleString() + ' تومان';
      reserveBtn.disabled = arr.length === 0;
    }

    document.getElementById('reserveBtn').addEventListener('click', () => {
      if (selected.size === 0) return;
      fetch("/api/reserve/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ show_time: "{{ show_time.id }}", seat: Array.from(selected) })
      })
      .then(r => r.json())
      .then(data => {
        console.log("Reserved:", data);
        selected.clear();
        refreshSummary();
      });
    });

    const showtimeId = "{{ show_time.id }}";
    const socket = new WebSocket("ws://" + window.location.host + "/ws/showtime/" + showtimeId + "/");

    socket.onmessage = function(e) {
      const data = JSON.parse(e.data);
      const action = data.action;
      const seats = data.seats;
      seats.forEach(seatId => {
        const seatDiv = document.getElementById("seat-" + seatId);
        if (seatDiv) {
          seatDiv.classList.remove("taken","pending","selected");
          if (action === "reserved") seatDiv.classList.add("taken");
          else if (action === "pending") seatDiv.classList.add("pending");
        }
      });
    };
  </script>

</body>
</html>
